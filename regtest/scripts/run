#!/bin/bash

export valgrind=env

for opt in ${*}
do
case "$opt" in
(--valgrind) valgrind="valgrind --leak-check=full --show-reachable=yes" ;;
(*) echo error ; exit ;;
esac
done

{

date
echo "Running regtest in $(pwd)"

if [ "$valgrind" = valgrind ] ; then
echo "using valgrind"
fi

rm -fr tmp
mkdir tmp
cd tmp
cp -f ../* .

test -f config || {
  echo "FAILURE: config not found"
  exit 1
}

mpiprocs=0

source ./config

echo "++ Test type: $type"
echo "++ Arguments: $arg"
echo "++ Processors: $mpiprocs"

mpi=env
plumed=plumed

if ((mpiprocs>0)); then
mpi="mpirun -np $mpiprocs"

if ! plumed --has-mpi
then
  echo "NOT_APPLIABLE (MPI NOT INSTALLED)"
  exit 0;
fi

else

plumed="plumed --no-mpi"

fi

if ((mpiprocs>0)) && [[ "$valgrind" != "env" ]]
then
  echo "NOT_APPLIABLE (MPI cannot be used with valgrind)"
  exit 0;
fi

case "$type" in
(simplemd)
  test -f $(plumed info --root)/test/simplemd/simplemd || {
    echo "FAILURE: simplemd is not compiled"
    exit 1
  }
  test -f in || {
    echo "FAILURE: in file not present"
    exit 1
  }
  echo "Run simplemd"
  $mpi $valgrind $(plumed info --root)/test/simplemd/simplemd < in > out 2> err
  echo "Done. Here is the error file:"
  cat err
  ;;
(driver)
  echo "Run driver"
if ((mpiprocs==0)) ; then
  $mpi $valgrind plumed --no-mpi driver $arg > out 2> err
else
  $mpi $valgrind plumed driver $arg > out 2> err
fi
  echo "Done. Here is the error file:"
  cat err
 ;;
(*) echo "unknown test type" ; exit 1 ;;
esac


if ls *.reference > /dev/null
then
for file in *.reference ; do
  new="${file%.reference}"
  if test -f "$new" ; then
    out="$(diff "$file" "$new")"
    test -n "$out" && {
      echo FAILURE
      echo "Diff for ${file%.reference}:"
      diff "${file}" "${file%.reference}"
    }
  else
    echo FAILURE
    echo FILE $new does not exist
  fi
done
else
    echo WARNING
    echo no file has been checked
fi


cd ../

} | tee report.txt
